# スキーマキャッシュ問題の最終解決手順

## 🔍 問題の原因

`PGRST205` エラーが続いている場合、以下の可能性があります：

1. **テーブル構造が正しくない**: アプリケーションが期待する構造と異なる
2. **PostgRESTのスキーマキャッシュが更新されていない**: 複数のリフレッシュ方法を試す必要がある
3. **プロジェクトの再起動が必要**: 一時停止と再開が必要な場合がある

## 🔧 解決手順

### ステップ1: テーブル構造の確認と修正

SQL Editor で、以下のSQLを実行してください：

```sql
-- CHECK_AND_FIX_INQUIRIES_TABLE.sql の内容を実行
```

**⚠️ 注意**: このSQLは既存の `inquiries` テーブルを削除して再作成します。**既存のデータは失われます**。

このSQLは以下を行います：
1. 現在のテーブル構造を確認
2. テーブルを削除して再作成（正しい構造で）
3. RLSポリシーとトリガーを設定
4. スキーマキャッシュをリフレッシュ

### ステップ2: 強制的なスキーマキャッシュのリフレッシュ

SQL Editor で、以下のSQLを実行してください：

```sql
-- FORCE_PGRST_REFRESH.sql の内容を実行
```

このSQLは以下を行います：
1. すべてのテーブルに直接アクセス
2. テーブルのメタデータにアクセス
3. PostgRESTにスキーマリロードを通知
4. 再度テーブルにアクセスして確認

### ステップ3: Supabase Dashboard でリフレッシュ

1. **Supabase Dashboard** を開く
2. **Settings** → **API** を開く
3. **「Reload schema cache」** ボタンをクリック
4. **30秒待つ**

### ステップ4: プロジェクトの一時停止と再開（最終手段）

もし上記の方法で解決しない場合：

1. **Supabase Dashboard** → **Settings** → **General**
2. **「Pause project」** をクリック
3. **30秒待つ**
4. **「Resume project」** をクリック
5. **数分待つ**（プロジェクトが完全に再起動するまで）

### ステップ5: ブラウザのキャッシュを完全にクリア

1. **ブラウザで `Ctrl + Shift + Delete`**（Windows）
2. **「すべての期間」**を選択
3. **以下をすべてチェック**:
   - 閲覧履歴
   - Cookie と他のサイトデータ
   - キャッシュされた画像とファイル
4. **「データを削除」**をクリック
5. **ブラウザを完全に再起動**

### ステップ6: アプリケーションで再度試す

1. **アプリケーションにログイン**
2. **「📧 お問い合わせ」**ボタンをクリック
3. **件名とメッセージを入力して送信**
4. **エラーが出ないか確認**

## 📝 確認チェックリスト

- [ ] `CHECK_AND_FIX_INQUIRIES_TABLE.sql` を実行
- [ ] `FORCE_PGRST_REFRESH.sql` を実行
- [ ] Supabase Dashboard で「Reload schema cache」を実行
- [ ] 2-3分待つ
- [ ] ブラウザのキャッシュを完全にクリア
- [ ] ブラウザを完全に再起動
- [ ] アプリケーションで再度試す

## 💡 重要なポイント

- **テーブル構造が正しいことを確認**してください（`user_id`、`user_email`、`user_name`、`subject`、`message`、`status` が必要）
- **スキーマキャッシュの更新には時間がかかります**（数秒から数分）
- **複数の方法を組み合わせて試す**と効果的です
- **プロジェクトの一時停止と再開**は最終手段ですが、効果的です

## 🔍 エラーが続く場合

エラーメッセージの**詳細**（エラーコード、メッセージ全文）を確認してください。

改善したエラーハンドリングにより、以下のような詳細なメッセージが表示されます：

- **スキーマキャッシュエラー（`PGRST205`）**: 解決方法が表示されます
- **テーブルが存在しない**: セットアップ手順が表示されます
- **その他のエラー**: エラーコードとメッセージが表示されます
