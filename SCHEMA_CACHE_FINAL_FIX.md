# スキーマキャッシュ問題の最終解決手順

## ✅ 現状確認

SQL実行の結果、`user_profiles` テーブルは存在し、`COUNT(*)` も正常に実行できています。これは、**データベースレベルではテーブルが正しく作成されている**ことを意味します。

問題は、**PostgRESTのスキーマキャッシュが更新されていない**可能性が高いです。

## 🔧 解決手順

### ステップ1: すべてのテーブルの存在確認

SQL Editor で、以下のSQLを実行して、`inquiries` と `documents` テーブルも存在するか確認してください：

```sql
-- すべてのテーブルの存在確認
SELECT 
  table_name,
  table_type
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('inquiries', 'documents', 'user_profiles')
ORDER BY table_name;
```

**期待される結果**:
- `inquiries` テーブルが表示される
- `documents` テーブルが表示される
- `user_profiles` テーブルが表示される

### ステップ2: スキーマキャッシュの強制リフレッシュ

SQL Editor で、以下のSQLを実行してください：

```sql
-- FORCE_SCHEMA_CACHE_REFRESH.sql の内容を実行
```

このSQLは以下を行います：
1. PostgRESTにスキーマリロードを通知
2. 各テーブルに直接アクセスしてキャッシュを更新
3. テーブルのメタデータにアクセス
4. 再度COUNT(*)を実行して確認

### ステップ3: Supabase Dashboard でリフレッシュ

1. **Supabase Dashboard** を開く
2. **Settings** → **API** を開く
3. **「Reload schema cache」** または **「Refresh schema」** ボタンをクリック
4. **30秒待つ**（重要：スキーマキャッシュの更新には時間がかかります）

### ステップ4: 再度 NOTIFY コマンドを実行

SQL Editor で以下を実行：

```sql
NOTIFY pgrst, 'reload schema';
```

### ステップ5: 数分待つ

スキーマキャッシュの更新には時間がかかる場合があります。**2-3分待ってから**次のステップに進んでください。

### ステップ6: ブラウザのキャッシュを完全にクリア

1. **ブラウザで `Ctrl + Shift + Delete`**（Windows）
2. **「すべての期間」**を選択
3. **以下をすべてチェック**:
   - 閲覧履歴
   - Cookie と他のサイトデータ
   - キャッシュされた画像とファイル
4. **「データを削除」**をクリック
5. **ブラウザを完全に再起動**

### ステップ7: アプリケーションで再度試す

1. **アプリケーションにログイン**
2. **「📧 お問い合わせ」**ボタンをクリック
3. **件名とメッセージを入力して送信**
4. **エラーが出ないか確認**

または：

1. **管理者でログイン**
2. **「📧 お問い合わせ管理」**を開く
3. **「📄 資料管理」**を開く
4. **エラーが出ないか確認**

## 🔍 まだエラーが出る場合

### エラーメッセージを確認

エラーメッセージの**詳細**（エラーコード、メッセージ全文）を確認してください。

改善したエラーハンドリングにより、以下のような詳細なメッセージが表示されます：

- **スキーマキャッシュエラー（`PGRST205`）**: 解決方法が表示されます
- **テーブルが存在しない**: セットアップ手順が表示されます
- **その他のエラー**: エラーコードとメッセージが表示されます

### 最終手段: プロジェクトの一時停止と再開

もし上記の方法で解決しない場合：

1. **Supabase Dashboard** → **Settings** → **General**
2. **「Pause project」** をクリック
3. **30秒待つ**
4. **「Resume project」** をクリック
5. **数分待つ**（プロジェクトが完全に再起動するまで）

## 📝 確認チェックリスト

- [ ] すべてのテーブル（`inquiries`、`documents`、`user_profiles`）が存在する
- [ ] `COUNT(*)` がすべてのテーブルで正常に実行できる
- [ ] `FORCE_SCHEMA_CACHE_REFRESH.sql` を実行
- [ ] Supabase Dashboard で「Reload schema cache」を実行
- [ ] `NOTIFY pgrst, 'reload schema';` を再度実行
- [ ] 2-3分待つ
- [ ] ブラウザのキャッシュを完全にクリア
- [ ] ブラウザを完全に再起動
- [ ] アプリケーションで再度試す

## 💡 重要なポイント

- **スキーマキャッシュの更新には時間がかかります**（数秒から数分）
- **複数の方法を組み合わせて試す**と効果的です
- **エラーメッセージの詳細を確認**すると、問題の原因を特定しやすくなります
- **データベースレベルではテーブルが存在する**ので、問題はスキーマキャッシュの更新のみです
